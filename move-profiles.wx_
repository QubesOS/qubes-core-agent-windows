<?xml version='1.0' encoding='windows-1252'?>
<Wix xmlns='http://schemas.microsoft.com/wix/2006/wi'>
  <?if $(env._BUILDARCH) = x86 ?>
    <?define ARCHDIR = i386 ?>
    <?define PFILESDIR = ProgramFilesFolder ?>
  <?elseif $(env._BUILDARCH) = AMD64 ?>
    <?define ARCHDIR = amd64 ?>
    <?define PFILESDIR = ProgramFiles64Folder ?>
  <?endif ?>

  <Module Id='moveProfiles'
    Language='1033' Codepage='1252' Version='$(env.VERSION)'>

    <Package Id='{8BA696C6-3769-441A-A54D-B40CF7CC271F}' Keywords='Installer' Description="Qubes Agent for Windows"
      Comments='no comment' Manufacturer='Invisible Things Lab' InstallScope='perMachine'
      InstallerVersion='200' Languages='1033' SummaryCodepage='1252'
      InstallPrivileges="elevated" Platform="x64"/>

    <Configuration Name="ProductFolder" Format="Key" Type="Identifier" DefaultValue="QubesProgramFilesDir"
      Description="Installation directory" DisplayName="Installation directory"/>
    <Substitution Table="Directory" Column="Directory_Parent"
      Row="BinDir" Value="[=ProductFolder]"/>

    <Directory Id='TARGETDIR' Name='SourceDir'>

      <Directory Id='$(var.PFILESDIR)'>
        <Directory Id='ITLProgramFilesDir' Name='Invisible Things Lab'>
          <Directory Id='QubesProgramFilesDir' Name='Qubes'>
            <Directory Id='BinDir' Name='bin'>
              <Component Id='PrepareVolume' Guid='220A22F3-0B73-4A4C-B825-53132A88D1DF'>
                <File Id='prepare_volume.exe' Name='prepare-volume.exe' DiskId='1' Source='prepare-volume\bin\$(var.ARCHDIR)\prepare-volume.exe' KeyPath="no" />
                <!-- This needs to run *after* Xen disk drivers are loaded, so can't run directly during install as drivers will load after reboot. -->
                <RegistryValue Root="HKLM" Key="SOFTWARE\Microsoft\Windows\CurrentVersion\RunOnce" Name="QTW Move Profiles" Type="string" Value="[BinDir]prepare-volume.exe 51728"/>
              </Component>
            </Directory>
          </Directory>
        </Directory>
      </Directory>

      <Directory Id="WindowsFolder">
        <Directory Id="System64Folder">
          <Component Id='MoveProfiles' Guid='C4325378-B946-4C6C-A685-F3E39A10AF20' Win64='yes'>
            <File Id='move_profiles.exe' Name='move-profiles.exe' DiskId='1' Source='move-profiles\bin\$(var.ARCHDIR)\move-profiles.exe' KeyPath='yes' />
          </Component>
        </Directory>
      </Directory>

    </Directory>

  </Module>
</Wix>
